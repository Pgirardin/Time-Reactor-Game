using UnityEngine;

/// <summary>
/// Реализация полёта пули, урона от неё, взаимодействия с объектами и её уничтожения
/// </summary>
public class Bullet : MonoBehaviour
{
    private Rigidbody rigidBody;
    Vector3 previousPosition;

    [SerializeField] private int damage = 1;
    [SerializeField] private int velocity = 15;
    [SerializeField] private float timeToDestruct = 3f;
    // Дальность луча, исходящего в обратную сторону по траектории пули(для небольших скоростей лучше не ставить больше, чем 0.5f)
    [SerializeField] private float backRayDistance = 0.5f;

    void Awake()
    {
        rigidBody = GetComponent<Rigidbody>();
        previousPosition = transform.position;
        Destroy(gameObject, timeToDestruct);
    }

    void FixedUpdate()
    {
        var hitInfo = CheckCollision();
        if (hitInfo != null)
        {
            Destroy(gameObject);
            PerformCollisionEffects(((RaycastHit)hitInfo).collider);
        }
        previousPosition = transform.position;
    }

    private void OnTriggerEnter(Collider other)
    {
        Destroy(gameObject);
        PerformCollisionEffects(other);
    }

    /// <summary>
    /// Придать пуле кинетическую энергию
    /// </summary>
    public void GiveBulletKineticEnergy(Vector3 bulletDirection)
    {
        rigidBody.velocity = bulletDirection * velocity;
    }

    /// <summary>
    /// Проверка на столкновение с другими объектами (для объектов с большой скоростью)
    /// </summary>
    private RaycastHit? CheckCollision()
    {
        Vector3 currentTrajectory = (transform.position - previousPosition) / Vector3.Distance(transform.position, previousPosition);
        var backRay = new Ray(transform.position, -currentTrajectory);
        RaycastHit hit;
        int defaultLayerMask = 1;

        if (Physics.Raycast(backRay, out hit, backRayDistance, defaultLayerMask, QueryTriggerInteraction.Ignore))
        {
            return hit;
        }
        return null;
    }

    /// <summary>
    /// Произвести действия над объектом после столкновения пули с ним
    /// </summary>
    private void PerformCollisionEffects(Collider hitObjectCollider)
    {
        var entity = hitObjectCollider.gameObject.GetComponent<Entity>();
        if (entity != null)
        {
            entity.TakeDamage(damage);
        }
    }
}